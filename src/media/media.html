<!doctype html>
<html lang="en" class="dark">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="../style/app.css" />
        <title>MMS Web</title>
    </head>
    <body>
    <div class="controls m-2 flex space-x-2">
        <input type="file" class="btn" id="imageUpload" accept="image/*">
        <button class="btn" onclick="applyGrayscaleFilter()">Grayscale</button>
        <button class="btn" onclick="applyThresholdFilter()">Threshold</button>
        <button class="btn" onclick="applyInvertFilter()">Invert</button>
        <button class="btn" onclick="applySepiaFilter()">Sepia</button>
        <button class="btn" onclick="resetImage()">Reset</button>
    </div>
    <canvas id="canvas"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        let originalImageData = null;

        document.getElementById("imageUpload").oninput = async (evt) => {
            try {
                const file = evt.target.files[0];
                const bitmap = await createImageBitmap(file);
                canvas.width = bitmap.width;
                canvas.height = bitmap.height;
                ctx.drawImage(bitmap, 0, 0);
                originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            }
            catch(err) {
                console.error(err);
            }
        };

        function applyGrayscaleFilter() {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            for (let i = 0; i < data.length; i+=4) {
                const avg = (data[i] + data[i+1] + data[i+2]) / 3;
                data[i] = avg;
                data[i+1] = avg;
                data[i+2] = avg;
            }

            ctx.putImageData(imageData, 0, 0);
        }

        function applyThresholdFilter() {
            const threshold = 128;  // TODO: Implement slider to change this value
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            for (let i = 0; i < data.length; i+=4) {
                const avg = (data[i] + data[i+1] + data[i+2]) / 3;
                data[i] = avg < threshold ? 0 : 255;
                data[i+1] = avg < threshold ? 0 : 255;
                data[i+2] = avg < threshold ? 0 : 255;
            }

            ctx.putImageData(imageData, 0, 0);
        }

        function applyInvertFilter() {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            for (let i = 0; i < data.length; i+=4) {
                data[i] = 255 - data[i];
                data[i+1] = 255 - data[i+1];
                data[i+2] = 255 - data[i+2];
            }

            ctx.putImageData(imageData, 0, 0);
        }

        function applySepiaFilter() {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            for (let i = 0; i < data.length; i+=4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];

                data[i] = Math.min(255, r * 0.393 + g * 0.769 + b * 0.189);
                data[i+1] = Math.min(255, r * 0.349 + g * 0.686 + b * 0.168);
                data[i+2] = Math.min(255, r * 0.272 + g * 0.534 + b * 0.131);
            }

            ctx.putImageData(imageData, 0, 0);
        }

        function resetImage() {
            if (originalImageData) {
                ctx.putImageData(originalImageData, 0, 0);
            }
        }
    </script>
    </body>
</html>
